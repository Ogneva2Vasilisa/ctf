# Задание 5

[NEOQUEST-2024: write-up задания «Бой с тенью» (vk.com)](https://vk.com/@neoquest-neoquest-2024-write-up-zadaniya-boi-s-tenu)

**Флаг**: NQ2024ed303ca9f9fdd2a5038729dc1177439df1e7d1126a86ea1e5eee1f6d05830915

**Входные параметры**: только ссылка на главную страницу веб-приложения.

**Запуск:**

user@user-virtual-machine:~$sudo python3 NeoQuest/flaskapp.py

---

**Решение:**

Мы находимся на главной странице веб-приложения:

![https://sun9-47.userapi.com/impg/l-pV_MsSks6Llci0sfb8uJW0eRgT5mH6GuOSRw/orwvnvBwEJE.jpg?size=807x466&quality=95&sign=37a3dbeceeead0dfef7c88351cf2ab89&type=album](https://sun9-47.userapi.com/impg/l-pV_MsSks6Llci0sfb8uJW0eRgT5mH6GuOSRw/orwvnvBwEJE.jpg?size=807x466&quality=95&sign=37a3dbeceeead0dfef7c88351cf2ab89&type=album)

Перед нами поле для загрузки файла и два поля для ввода параметров.

Изучим структуру страницы через консоль разработчика:

На странице подгружается файл encoding_algorithm.js, изучим код данного файла:

![https://sun9-54.userapi.com/impg/Nl3-hFKcOkjzQajE0CWewVlBmfIjOkVyprhNug/HuP1bH2LrbE.jpg?size=807x335&quality=95&sign=ed17cf11aac0be9727ad470f11379859&type=album](https://sun9-54.userapi.com/impg/Nl3-hFKcOkjzQajE0CWewVlBmfIjOkVyprhNug/HuP1bH2LrbE.jpg?size=807x335&quality=95&sign=ed17cf11aac0be9727ad470f11379859&type=album)

Открываем его и видим, что он обфусцирован:

![https://sun9-9.userapi.com/impg/esfDAZsqXI98XDUqEfUnaCdQKCTatgRXTo7S2A/mWRoEFjBP_A.jpg?size=474x270&quality=95&sign=fad6f193a2df39557c18328cd51e39e1&type=album](https://sun9-9.userapi.com/impg/esfDAZsqXI98XDUqEfUnaCdQKCTatgRXTo7S2A/mWRoEFjBP_A.jpg?size=474x270&quality=95&sign=fad6f193a2df39557c18328cd51e39e1&type=album)

Используем деобфускатор, например [https://deobfuscate.io/](https://vk.com/away.php?to=https%3A%2F%2Fdeobfuscate.io%2F&cc_key=) и получаем следующий код:

```
**function** **readBytesFromFile**(_0x1c8e46) {

**return** **new** Promise((_0x239c58, _0x2619f7) => {

**const** _0x4c6100 = document.getElementById("fileInput");

**const** _0x26615a = _0x4c6100.files[0x0];

**if** (!_0x26615a) {

_0x2619f7("File was not selected.");

**return**;

}

**const** _0x342e95 = **new** FileReader();

_0x342e95.readAsArrayBuffer(_0x26615a);

_0x342e95.onload = () => {

**const** _0x37fc66 = **new** Uint8Array(_0x342e95.result);

**const** _0x14be37 = Array.from(_0x37fc66);

_0x239c58(_0x14be37);

};

_0x342e95.onerror = () => {

_0x2619f7("Error reading the file.");

};

});

}

**function** **generateNumber**(_0x10c95f, _0x2229f5, _0x3a1c0a, _0x319e59) {

_0x2229f5 = BigInt(_0x2229f5);

_0x3a1c0a = BigInt(_0x3a1c0a);

_0x319e59 = BigInt(_0x319e59);

_0x10c95f = BigInt(_0x10c95f);

**return** (_0x2229f5 * _0x10c95f + _0x3a1c0a) % _0x319e59;

}

**function** **generateArray**(_0x319fd7, _0x53d388, _0x15a610) {

**let** _0x33f45a = [0xef49, 0xec3b, 0xe63b];

**let** _0xe2435f = [generateNumber(0x1, _0x53d388, _0x15a610, _0x33f45a[0x0]), generateNumber(0x1, _0x53d388, _0x15a610, _0x33f45a[0x1]), generateNumber(0x1, _0x53d388, _0x15a610, _0x33f45a[0x2])];

**while** (_0xe2435f.length < _0x319fd7) {

_0xe2435f.push(generateNumber(_0xe2435f[_0xe2435f.length - 0x3], _0x53d388, _0x15a610, _0x33f45a[_0xe2435f.length % 0x3]));

}

**return** _0xe2435f;

}

**function** **splitArray**(_0x55c373) {

**const** _0x2b2a3c = [];

_0x55c373.forEach(_0x2fa1a1 => {

**const** _0x2706f0 = _0x2fa1a1 & BigInt(0xff);

**const** _0x41978d = _0x2fa1a1 >> BigInt(0x8) & BigInt(0xff);

_0x2b2a3c.push(_0x41978d, _0x2706f0);

});

**return** _0x2b2a3c;

}

**function** **arrayToString**(_0x1a77c7) {

**return** _0x1a77c7.map(_0x440a7d => String.fromCharCode(Number(_0x440a7d))).join('');

}

**function** **xorTwoArrays**(_0x2361ab, _0x39c972) {

**const** _0x4639d4 = Math.min(_0x2361ab.length, _0x39c972.length);

**const** _0x295fad = [];

**for** (**let** _0x29af31 = 0x0; _0x29af31 < _0x4639d4; _0x29af31++) {

**const** _0x5d9210 = BigInt(_0x2361ab[_0x29af31]) ^ BigInt(_0x39c972[_0x29af31]);

_0x295fad.push(_0x5d9210);

}

**return** _0x295fad;

}

document.getElementById("calculateBtn").addEventListener("click", **function** () {

readBytesFromFile().then(_0x3c8843 => {

**var** _0x2303be = parseInt(document.getElementById('num1').value);

**var** _0x557d6e = parseInt(document.getElementById("num2").value);

**if** (!isNaN(_0x2303be) && !isNaN(_0x557d6e)) {

**var** _0x215bb4 = splitArray(generateArray(0x23, _0x2303be, _0x557d6e));

result = arrayToString(xorTwoArrays(_0x215bb4, _0x3c8843));

document.getElementById("result").innerText = "Result: " + result;

**}**

**})["catch"](_0x25f96f => {**

**document.getElementById("result").innerText = _0x25f96f;**

**});**

**});**

```
---

Теперь алгоритм кодирования может быть изучен. При нажатии кнопки на главной странице из файла считываются байты и представляются в виде числового массива.

**function** **readBytesFromFile**(_0x1c8e46) {

**return** **new** Promise((_0x239c58, _0x2619f7) => {

**const** _0x4c6100 = document.getElementById("fileInput");

**const** _0x26615a = _0x4c6100.files[0x0];

**if** (!_0x26615a) {

_0x2619f7("File was not selected.");

**return**;

}

**const** _0x342e95 = **new** FileReader();

_0x342e95.readAsArrayBuffer(_0x26615a);

_0x342e95.onload = () => {

**const** _0x37fc66 = **new** Uint8Array(_0x342e95.result);

**const** _0x14be37 = Array.from(_0x37fc66);

_0x239c58(_0x14be37);

};

_0x342e95.onerror = () => {

_0x2619f7("Error reading the file.");

};

});

}

---

Затем, используя введенные параметры, из чисел, возвращаемых функцией generateNumber(), создается массив:

**function** **generateArray**(_0x319fd7, _0x53d388, *0x15a610) {**let*** M_list= [0xef49, 0xec3b, 0xe63b];**let** _0xe2435f = [generateNumber(0x1, _0x53d388, _0x15a610, _0x33f45a[0x0]), generateNumber(0x1, _0x53d388, _0x15a610, _0x33f45a[0x1]), generateNumber(0x1, _0x53d388, _0x15a610, _0x33f45a[0x2])];**while** (_0xe2435f.length < _0x319fd7) {_0xe2435f.push(generateNumber(_0xe2435f[_0xe2435f.length - 0x3], _0x53d388, _0x15a610, _0x33f45a[_0xe2435f.length % 0x3]));}**return** _0xe2435f;}

---

Функция generateNumber() использует три ЛКГ с одинаковыми параметрами и различными модулями из массива M. В дальнейшем для удобства первый введенный параметр будем называть A, а второй C.

**function** **generateNumber**(_0x10c95f, A, C, M) {

_0x2229f5 = BigInt(_0x2229f5);

_0x3a1c0a = BigInt(_0x3a1c0a);

_0x319e59 = BigInt(_0x319e59);

_0x10c95f = BigInt(_0x10c95f);

**return** (A * _0x10c95f + C) % M;

}

---

Затем полученный производится поэлементный XOR сгенерированного массива и массива, полученного из файла.

**function** **xorTwoArrays**(_0x2361ab, _0x39c972) {

**const** _0x4639d4 = Math.min(_0x2361ab.length, _0x39c972.length);

**const** _0x295fad = [];

**for** (**let** _0x29af31 = 0x0; _0x29af31 < _0x4639d4; _0x29af31++) {

**const** _0x5d9210 = BigInt(_0x2361ab[_0x29af31]) ^ BigInt(_0x39c972[_0x29af31]);

_0x295fad.push(_0x5d9210);

}

**return** _0x295fad;

}

---

Но параметры кодирования по-прежнему не могут быть определены, а также флаг не найден.

Продолжаем изучение сайта. Попробуем открыть robots.txt, чтобы узнать, какие еще страницы есть:

![https://sun9-76.userapi.com/impg/ElFC2lzkMmeerrOdfA-5SFoT1IRQkgSrWYDuXQ/wbbsv_mVWCo.jpg?size=320x154&quality=95&sign=677650733cb04786c70f5cbed561c817&type=album](https://sun9-76.userapi.com/impg/ElFC2lzkMmeerrOdfA-5SFoT1IRQkgSrWYDuXQ/wbbsv_mVWCo.jpg?size=320x154&quality=95&sign=677650733cb04786c70f5cbed561c817&type=album)

На сайте помимо главной существуют еще три страницы. Откроем history:

![https://sun9-6.userapi.com/impg/GmTFM0csiCR20TSRqJNFN-Fk4K6uUwN-g8PuCA/3joxMkLKkXQ.jpg?size=807x337&quality=95&sign=a0bc4e8b960dc0701590c5133690276c&type=album](https://sun9-6.userapi.com/impg/GmTFM0csiCR20TSRqJNFN-Fk4K6uUwN-g8PuCA/3joxMkLKkXQ.jpg?size=807x337&quality=95&sign=a0bc4e8b960dc0701590c5133690276c&type=album)

Видим список файлов, доступных для скачивания и файлы, которые скачать нельзя.

Сначала скачаем файл test.txt и test.bin.

![https://sun9-28.userapi.com/impg/cep58YB3o9shppWk2mLuoaPRoZry8aRhJuO0pw/HEVh3VGuQuM.jpg?size=807x142&quality=95&sign=a8cb56c128ad58a59bb29fc1225ed775&type=album](https://sun9-28.userapi.com/impg/cep58YB3o9shppWk2mLuoaPRoZry8aRhJuO0pw/HEVh3VGuQuM.jpg?size=807x142&quality=95&sign=a8cb56c128ad58a59bb29fc1225ed775&type=album)

![https://sun9-24.userapi.com/impg/mAg24Nv7IKAhpYf8r85BvTY7wrbW7icbRwBiTQ/I7K6D09dYtw.jpg?size=807x177&quality=95&sign=e271664268bc5f38e32f13248909aa4c&type=album](https://sun9-24.userapi.com/impg/mAg24Nv7IKAhpYf8r85BvTY7wrbW7icbRwBiTQ/I7K6D09dYtw.jpg?size=807x177&quality=95&sign=e271664268bc5f38e32f13248909aa4c&type=album)

можно предположить, что перед нами один и тот же файл до и после кодирования на сайте. Далее решение части, связанной с криптографией, будет описано на python.

Прочитаем байты закодированного файла:

![https://sun9-44.userapi.com/impg/kCUF_TKa3EI_QDQqTyh6lNhpu1WpucNgFpacDQ/PB8wTb8ebj4.jpg?size=643x81&quality=95&sign=b86b39d9091371d3d74d45172aa22391&type=album](https://sun9-44.userapi.com/impg/kCUF_TKa3EI_QDQqTyh6lNhpu1WpucNgFpacDQ/PB8wTb8ebj4.jpg?size=643x81&quality=95&sign=b86b39d9091371d3d74d45172aa22391&type=album)

так как нам известен текст изначального сообщения, можно подобрать значения, использовавшиеся при кодировании:

![https://sun9-50.userapi.com/impg/i08z2GpmBHQnBhfg8BXT5rPpuYtuAGlGEV1bAQ/0MmpWnf_XOA.jpg?size=643x222&quality=95&sign=2109a8a33002d42627294e5a6976ae2f&type=album](https://sun9-50.userapi.com/impg/i08z2GpmBHQnBhfg8BXT5rPpuYtuAGlGEV1bAQ/0MmpWnf_XOA.jpg?size=643x222&quality=95&sign=2109a8a33002d42627294e5a6976ae2f&type=album)

по изученному алгоритму кодирования можно понять, что использовался one-time pad для кодирования, поэтому подобранные значения не помогут восстановить все сообщение, только первые его 12 символов.

Но благодаря этим 12 числам можно “собрать” первые 6 чисел, сгенерированных генератором псевдослучайных чисел(фактически обратить функцию splitArray() ):

![https://sun9-15.userapi.com/impg/zK0cX7nAbSxD4ck4Q2QYZ0g-GnePTlyee7FTxA/2D-3cm5jSCs.jpg?size=644x144&quality=95&sign=25ef05c01d67a1b7f90ce21ab7fa7a18&type=album](https://sun9-15.userapi.com/impg/zK0cX7nAbSxD4ck4Q2QYZ0g-GnePTlyee7FTxA/2D-3cm5jSCs.jpg?size=644x144&quality=95&sign=25ef05c01d67a1b7f90ce21ab7fa7a18&type=album)

Из данных 6 чисел, зная функцию, которой была сгенерирована последовательность, включавшая их (разобранные ранее функции generateNumber и generateArray) можно составить систему уравнений:

![https://sun9-38.userapi.com/impg/TfKznbkFyby-4KrenLG4i-InXSI0n8MS1mYDhA/DjnvRKpCmgQ.jpg?size=452x256&quality=95&sign=f9a046f416fa1f435878eac9a02b4c46&type=album](https://sun9-38.userapi.com/impg/TfKznbkFyby-4KrenLG4i-InXSI0n8MS1mYDhA/DjnvRKpCmgQ.jpg?size=452x256&quality=95&sign=f9a046f416fa1f435878eac9a02b4c46&type=album)

Выражаем из данной системы параметр А, а уже через него параметр C:

![https://sun9-15.userapi.com/impg/S-hLnW8TlRVE1_JCpF3Q6AX7Y5H9uX_JjoaHGQ/2H7drK9D5MQ.jpg?size=325x256&quality=95&sign=be3697ef701b896de40c6d2345bf1513&type=album](https://sun9-15.userapi.com/impg/S-hLnW8TlRVE1_JCpF3Q6AX7Y5H9uX_JjoaHGQ/2H7drK9D5MQ.jpg?size=325x256&quality=95&sign=be3697ef701b896de40c6d2345bf1513&type=album)

Получили две системы уравнений, каждая из которых может быть решена с помощью Китайской теоремы об остатках (например тут [https://www.dcode.fr/chinese-remainder](https://vk.com/away.php?to=https%3A%2F%2Fwww.dcode.fr%2Fchinese-remainder&cc_key=) ):

![https://sun9-22.userapi.com/impg/b_Gsi5KXUr-oKy3d_sUyeesN5fOW6xkmg96PQw/6OQbyAYZI4c.jpg?size=807x323&quality=95&sign=d4b3f6ac23ae728fbf432e585d4863ba&type=album](https://sun9-22.userapi.com/impg/b_Gsi5KXUr-oKy3d_sUyeesN5fOW6xkmg96PQw/6OQbyAYZI4c.jpg?size=807x323&quality=95&sign=d4b3f6ac23ae728fbf432e585d4863ba&type=album)

![https://sun9-43.userapi.com/impg/KWtujVpxObgpsVBcNe64fbMHM0Q2CI_yDWtXcw/SOEwU56RDHg.jpg?size=807x262&quality=95&sign=f7e596770cecc0fb5b70356db41d012f&type=album](https://sun9-43.userapi.com/impg/KWtujVpxObgpsVBcNe64fbMHM0Q2CI_yDWtXcw/SOEwU56RDHg.jpg?size=807x262&quality=95&sign=f7e596770cecc0fb5b70356db41d012f&type=album)

Теперь нам известны параметры кодирования, осталось получить доступ к flag.bin

Рассмотрим последнюю нетронутую страницу aboutme, на ней создатель сайта рассказывает о том, что абсолютно все на написанных им сайтах происходит на стороне клиента. Одним из способов, которыми сайт может идентифицировать клиентов является cookie, под описание автора они тоже подходят. Рассмотрим, через любое из расширений браузера, позволяющее редактировать cookie, например Cookie Editor:

![https://sun9-42.userapi.com/impg/4tSxjMLIqL9RDRpkWIKOVp7tX2oZodCeCTQN-A/fPoOgEpZjMk.jpg?size=807x366&quality=95&sign=a3e572205343e5a15f457354fb2b52e4&type=album](https://sun9-42.userapi.com/impg/4tSxjMLIqL9RDRpkWIKOVp7tX2oZodCeCTQN-A/fPoOgEpZjMk.jpg?size=807x366&quality=95&sign=a3e572205343e5a15f457354fb2b52e4&type=album)

Изменим на значение is_admin на True, обновим страницу и получим возможность скачать файл flag.bin

![https://sun9-22.userapi.com/impg/Zck3GW2nzTVA_inlk34gZKhMTNuqdWbh5R4_zA/dvN2M4SP-QY.jpg?size=807x322&quality=95&sign=f9174e7375d8d79d45e864eec400f091&type=album](https://sun9-22.userapi.com/impg/Zck3GW2nzTVA_inlk34gZKhMTNuqdWbh5R4_zA/dvN2M4SP-QY.jpg?size=807x322&quality=95&sign=f9174e7375d8d79d45e864eec400f091&type=album)

Загрузим данный файл, введем полученные ранее параметры и получим флаг.

![https://sun9-46.userapi.com/impg/iCeFTnPIKQmmZTNc_sz_v9sGINWAHPyg6elpIg/BCLYqz1B97A.jpg?size=807x393&quality=95&sign=3104ad79dc6da29b50d7b557bd479ebc&type=album](https://sun9-46.userapi.com/impg/iCeFTnPIKQmmZTNc_sz_v9sGINWAHPyg6elpIg/BCLYqz1B97A.jpg?size=807x393&quality=95&sign=3104ad79dc6da29b50d7b557bd479ebc&type=album)